<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nearnet.in - Home</title>
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <style>
    /* Global resets and typography */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; color: #333; transition: background 0.3s ease; }
    
    /* Header */
    header {
      background: #2c3e50;
      color: #fff;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    header h1 { font-size: 1.8rem; }
    header p { font-size: 0.9rem; margin-top: 0.3rem; opacity: 0.8; }
    
    /* Main container and sections */
    .container { max-width: 1200px; margin: 70px auto 70px; padding: 0 1rem; } /* leave space for bottom nav */
    .section { display: none; }
    .section.active { display: block; }
    
    /* Home Section */
    .welcome { margin: 1rem 0; font-size: 1.2rem; }
    .dashboard {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }
    .dashboard:hover { transform: scale(1.01); }
    .dashboard h3 {
      margin-bottom: 0.8rem;
      border-bottom: 2px solid #eee;
      padding-bottom: 0.5rem;
      color: #2c3e50;
      font-size: 1rem;
    }
    
    /* Event Cards */
    .event-card {
      background: #fff;
      padding: 0.8rem;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 0.8rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .event-card:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .event-card h4 { font-size: 0.95rem; margin-bottom: 0.3rem; color: #2c3e50; }
    .event-card p { font-size: 0.85rem; color: #555; margin-bottom: 0.3rem; }
    .event-card .event-status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-active { background: #27ae60; color: #fff; }
    .status-completed { background: #7f8c8d; color: #fff; }
    .status-help { background: #e67e22; color: #fff; }
    .time-remaining { font-weight: bold; color: #e74c3c; margin-left: 0.3rem; font-size: 0.8rem; }
    .see-more-btn {
      background: #3498db;
      border: none;
      color: #fff;
      padding: 0.3rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .see-more-btn:hover { background: #2980b9; }
    
    /* Create Section */
    .create-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }
    .create-buttons button {
      padding: 1rem;
      font-size: 1rem;
      background: #e67e22;
      border: none;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
      transition: background 0.3s ease;
    }
    .create-buttons button:hover { background: #d35400; }
    
    /* Coins Section */
    .coins-section {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-top: 1rem;
      transition: background 0.3s ease;
    }
    .coins-section h4 { margin-bottom: 0.5rem; color: #2c3e50; font-size: 1rem; }
    
    /* Profile Section */
    .profile-section button {
      display: block;
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.75rem;
      border: none;
      background: #3498db;
      color: #fff;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .profile-section button:hover { background: #2980b9; }
    
    /* Bottom Navigation Bar */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: #fff;
      box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.5rem 0;
      z-index: 1000;
    }
    .bottom-nav button {
      border: none;
      background: none;
      font-size: 0.85rem;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .bottom-nav button:hover { color: #3498db; }
    .bottom-nav i { font-size: 1.2rem; margin-bottom: 0.2rem; }
    
    /* Overlays */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .overlay-content {
      background: #fff;
      border-radius: 8px;
      padding: 1.5rem;
      max-width: 500px;
      width: 95%;
      position: relative;
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .overlay-content button.close-overlay {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    /* Spinner */
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 1rem auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Urgent Warning Icon */
    .urgent-warning {
      color: red;
      font-size: 1.2rem;
      margin-left: 0.5rem;
    }
    
    /* Mobile adjustments */
    @media (max-width:768px) {
      header h1 { font-size: 1.4rem; }
      header p { font-size: 0.8rem; }
      .container { padding: 0 0.5rem; }
      .bottom-nav button { font-size: 0.75rem; }
      .bottom-nav i { font-size: 1rem; }
    }
  </style>
  
  <!-- Include QR Scanner & QRCode generator libraries -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>nearnet.in</h1>
    <p>Network of nearest people</p>
  </header>
  
  <!-- Main Container with Sections -->
  <div class="container">
    <!-- Home Section -->
    <div id="homeSection" class="section active">
      <div class="welcome" id="welcomeMessage">Welcome, User!</div>
      
      <!-- Available Events -->
      <div class="dashboard">
        <h3>Available Events</h3>
        <div class="radius-selector">
          <label for="radiusSelector">Show events within:</label>
          <select id="radiusSelector">
            <option value="1000">1 km</option>
            <option value="3000">3 km</option>
            <option value="5000">5 km</option>
          </select>
        </div>
        <div id="availableEventsList">
          <div class="spinner" id="availableEventsSpinner"></div>
        </div>
      </div>
      
      <!-- Your Created Events -->
      <div class="dashboard">
        <h3>Your Created Events</h3>
        <div id="createdEventsList">
          <div class="spinner" id="createdEventsSpinner"></div>
        </div>
      </div>
    </div>
    
    <!-- Create Section -->
    <div id="createSection" class="section">
      <h2 style="margin-top:1rem; text-align:center;">Create Events / Requests</h2>
      <div class="create-buttons">
        <button id="askHelpBtn"><i class="fa-solid fa-hands-helping"></i> Ask Help</button>
        <button id="urgentEmergencyBtn"><i class="fa-solid fa-bell"></i> Urgent Emergency</button>
        <button id="hostEventBtn"><i class="fa-solid fa-calendar-check"></i> Host Event</button>
        <button id="exchangeBtn"><i class="fa-solid fa-arrows-rotate"></i> Exchange/Borrow</button>
        <button id="onlineGamesBtn"><i class="fa-solid fa-gamepad"></i> Online Games</button>
      </div>
    </div>
    
    <!-- Coins Section -->
    <div id="coinsSection" class="section">
      <div class="coins-section">
        <h4>Nearnext Coins: <span id="rewardPoints">0</span></h4>
        <p>Earn coins by attending events!</p>
      </div>
    </div>
    
    <!-- Profile Section -->
    <div id="profileSection" class="section">
      <div class="profile-section" style="margin-top:1rem;">
        <button id="myQRBtn"><i class="fa-solid fa-qrcode"></i> My QR</button>
        <button id="editProfileBtn"><i class="fa-solid fa-user-pen"></i> Edit Profile</button>
        <button id="logoutBtn"><i class="fa-solid fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
  </div>
  
  <!-- Bottom Navigation Bar -->
  <div class="bottom-nav">
    <button data-section="homeSection"><i class="fa-solid fa-home"></i><span>Home</span></button>
    <button data-section="createSection"><i class="fa-solid fa-plus-square"></i><span>Create</span></button>
    <button data-section="coinsSection"><i class="fa-solid fa-coins"></i><span>Coins</span></button>
    <button data-section="profileSection"><i class="fa-solid fa-user"></i><span>Profile</span></button>
  </div>
  
  <!-- Overlays -->
  <!-- QR Code Overlay (My QR) -->
  <div class="overlay" id="qrOverlay">
    <div class="overlay-content">
      <button class="close-overlay" onclick="closeOverlay('qrOverlay')">&times;</button>
      <h3>Your QR Code</h3>
      <div id="qrCodeContainer" style="text-align:center;"></div>
    </div>
  </div>
  
  <!-- Event Details Overlay -->
  <div class="overlay" id="eventDetailsOverlay">
    <div class="overlay-content">
      <button class="close-overlay" onclick="closeOverlay('eventDetailsOverlay')">&times;</button>
      <div id="eventDetailsContent"></div>
    </div>
  </div>
  
  <!-- Ask Help Overlay -->
  <div class="overlay" id="askHelpOverlay">
    <div class="overlay-content">
      <button class="close-overlay" onclick="closeOverlay('askHelpOverlay')">&times;</button>
      <h3>Ask for Help</h3>
      <form id="askHelpForm" class="ask-help-form">
        <textarea id="helpDetails" placeholder="Describe what help you need" required></textarea>
        <input type="number" id="volunteersNeeded" placeholder="Number of volunteers needed" required min="1" />
        <input type="text" id="helpLocation" placeholder="Help Location" readonly required />
        <button type="button" id="updateHelpLocationBtn">Update Location</button>
        <label for="helpExpireTime">Expire Time:</label>
        <select id="helpExpireTime">
          <option value="3600">1 Hour</option>
          <option value="10800">3 Hours</option>
          <option value="21600">6 Hours</option>
          <option value="43200">12 Hours</option>
          <option value="86400">24 Hours</option>
        </select>
        <button type="submit">Submit Help Request</button>
      </form>
    </div>
  </div>
  
  <!-- Urgent Emergency Overlay -->
  <div class="overlay" id="urgentEmergencyOverlay">
    <div class="overlay-content">
      <button class="close-overlay" onclick="closeOverlay('urgentEmergencyOverlay')">&times;</button>
      <h3>Urgent Emergency</h3>
      <p>Please record your emergency message. Click "Record Voice" to start.</p>
      <textarea id="emergencyVoiceMsg" placeholder="Transcribed message will appear here" readonly style="height:80px;"></textarea>
      <button id="recordVoiceBtn">Record Voice</button>
      <button id="submitEmergencyBtn">Submit Emergency</button>
    </div>
  </div>
  
  <!-- Edit Profile Overlay -->
  <div class="overlay" id="editProfileOverlay">
    <div class="overlay-content">
      <button class="close-overlay" onclick="closeOverlay('editProfileOverlay')">&times;</button>
      <h3>Edit Profile</h3>
      <form id="editProfileForm">
        <input type="text" id="editName" placeholder="Name" required />
        <input type="text" id="editPhone" placeholder="Phone" required />
        <input type="email" id="editEmail" placeholder="Email" required />
        <input type="password" id="editPassword" placeholder="New Password (optional)" />
        <input type="text" id="editLocation" placeholder="Location" readonly required />
        <div class="location-display" id="editLocationDisplay">Fetching location...</div>
        <button type="button" id="editGetLocationBtn"><i class="fa-solid fa-location-dot"></i> Get Location</button>
        <button type="submit">Save Changes</button>
      </form>
    </div>
  </div>
  
  <!-- QR Scanner Overlay for "Mark Helped" -->
  <div class="overlay" id="qrScannerOverlay">
    <div class="overlay-content">
      <button class="close-overlay" onclick="closeOverlay('qrScannerOverlay')">&times;</button>
      <h3>Scan Volunteer QR</h3>
      <div id="qr-reader" class="qr-scanner-container"></div>
      <button id="stopScannerBtn">Stop Scanner</button>
    </div>
  </div>
  
  <!-- SweetAlert2 and Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    console.log("Home page script started.");
    
    // Supabase Client Initialization
    const SUPABASE_URL = 'https://elxyhkfuuugjskallwsp.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVseHloa2Z1dXVnanNrYWxsd3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4MjA5ODksImV4cCI6MjA1NDM5Njk4OX0.BAEvcCVIQiVdsg0m3xX72Xi0p-vnJ4WqfZU0mE_Tuk0';
   
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Retrieve currentUser from localStorage
    let currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) { window.location.href = 'index.html'; }
    document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.name}!`;
    document.getElementById('rewardPoints').textContent = currentUser.reward_points || 0;
    
    // Bottom Navigation: Switch Sections
    const bottomNavButtons = document.querySelectorAll('.bottom-nav button');
    const sections = document.querySelectorAll('.section');
    bottomNavButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        sections.forEach(sec => sec.classList.remove('active'));
        const targetId = btn.getAttribute('data-section');
        document.getElementById(targetId).classList.add('active');
      });
    });


    
    // 3b. "My QR" button displays QR code for currentUser.user_id
    document.getElementById('myQRBtn').addEventListener('click', () => {
      document.getElementById('qrOverlay').style.display = 'flex';
      const qrContainer = document.getElementById('qrCodeContainer');
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: currentUser.user_id,
        width: 128,
        height: 128
      });
    });
    
    // Realtime Subscriptions using Supabase Realtime (v2 channel API)
    const eventsSubscription = supabaseClient
      .channel('public:events')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'events' },
        (payload) => {
          console.log('Realtime event change:', payload);
          loadEvents();
        }
      )
      .subscribe();
    
    const coinSubscription = supabaseClient
      .channel(`public:users_${currentUser.user_id}`)
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'users',
          filter: `user_id=eq.${currentUser.user_id}`
        },
        (payload) => {
          const newPoints = payload.new.reward_points;
          if (newPoints > currentUser.reward_points) {
            Swal.fire({ icon: 'success', title: 'Congratulations!', text: 'You got a new coin!' });
          }
          currentUser.reward_points = newPoints;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          document.getElementById('rewardPoints').textContent = newPoints;
        }
      )
      .subscribe();
    
    // Load Events Function (filters available events within selected radius)
    async function loadEvents() {
      console.log("Loading events...");
      const availableSpinner = document.getElementById('availableEventsSpinner');
      const createdSpinner = document.getElementById('createdEventsSpinner');
      if (availableSpinner) availableSpinner.style.display = 'block';
      if (createdSpinner) createdSpinner.style.display = 'block';
      try {
        const radius = parseInt(document.getElementById('radiusSelector').value);
        // Call RPC 'nearby_events' (which returns location as text via ST_AsText)
        let { data: nearbyEvents, error: nearbyError } = await supabaseClient.rpc('nearby_events', {
          current_location: currentUser.location,
          max_distance: radius
        });
        let { data: myEvents, error: myEventsError } = await supabaseClient
          .from('events')
          .select('*')
          .eq('user_id', currentUser.user_id);
        if (nearbyError || myEventsError) throw nearbyError || myEventsError;
        console.log("Events loaded:", nearbyEvents, myEvents);
        // Ensure nearbyEvents is not null
        const filteredNearby = (nearbyEvents || []).filter(e => e.user_id !== currentUser.user_id);
        renderEvents(filteredNearby, 'availableEventsList', true);
        renderEvents(myEvents, 'createdEventsList', false);
        updateTimeRemaining();
        clearUnusedUrgentIntervals(filteredNearby.filter(e => e.event_type === 'urgent').map(e => e.id));
      } catch (error) {
        console.error("Error loading events:", error.message);
        Swal.fire({ icon: 'error', title: 'Error', text: error.message });
      } finally {
        if (availableSpinner) availableSpinner.style.display = 'none';
        if (createdSpinner) createdSpinner.style.display = 'none';
      }
    }
    
    // Event Status: returns 'active', 'expired', or 'completed'
    function getEventStatus(event) {
      if (!event.status) return 'completed';
      if (!event.end_time) return 'active';
      const now = new Date();
      const endTime = new Date(event.end_time);
      return now > endTime ? 'expired' : 'active';
    }
    
    // Vibration Logic: non-urgent events vibrate once; urgent events vibrate continuously
    let vibratedEventIds = new Set();
    let urgentVibrationIntervals = {};
    function clearUnusedUrgentIntervals(renderedUrgentIds) {
      for (let id in urgentVibrationIntervals) {
        if (!renderedUrgentIds.includes(Number(id))) {
          clearInterval(urgentVibrationIntervals[id]);
          delete urgentVibrationIntervals[id];
        }
      }
    }
    
    // Render Events into given container; isAvailableList adds "Get Directions" button
    function renderEvents(events, containerId, isAvailableList) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      if (!events || events.length === 0) {
        container.innerHTML = '<p>No events found.</p>';
        return;
      }
      events.forEach(event => {
        const card = document.createElement('div');
        card.className = 'event-card';
        
        let eventLabel = '';
        let timerHTML = '';
        if (isAvailableList && event.event_type === 'urgent') {
          eventLabel = ' <span class="urgent-warning"><i class="fa-solid fa-exclamation-triangle"></i></span> [Urgent]';
          if (!urgentVibrationIntervals[event.id]) {
            urgentVibrationIntervals[event.id] = setInterval(() => {
              if (navigator.vibrate) { navigator.vibrate(200); }
            }, 5000);
          }
        } else if (event.event_type === 'help') {
          eventLabel = ' [Help Request]';
        }
        if (event.event_type !== 'urgent' && !vibratedEventIds.has(event.id) && navigator.vibrate) {
          navigator.vibrate(200);
          vibratedEventIds.add(event.id);
        }
        if (event.end_time) {
          timerHTML = `<span class="time-remaining" data-endtime="${event.end_time}"></span>`;
        }
        card.innerHTML = `
          <h4>${event.title}${eventLabel} ${timerHTML}</h4>
          <p>${event.description ? event.description.slice(0, 60) + '...' : ''}</p>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span class="event-status ${
              getEventStatus(event) === 'active'
                ? (event.event_type === 'help' ? 'status-help' : 'status-active')
                : 'status-completed'
            }">
              ${getEventStatus(event) === 'active' ? (event.event_type === 'help' ? 'Help' : 'Active') : 'Completed'}
            </span>
            <small>${(event.distance/1000).toFixed(1)} km away</small>
          </div>
          <button class="see-more-btn" style="margin-top:0.5rem;">See More</button>
          ${isAvailableList ? `<button class="get-direction-btn" style="margin-top:0.5rem;"><i class="fa-solid fa-location-dot"></i> Get Directions</button>` : ''}
        `;
        const seeMoreBtn = card.querySelector('.see-more-btn');
        seeMoreBtn.addEventListener('click', (evt) => {
          evt.stopPropagation();
          showEventDetails(event.id);
        });
        if (isAvailableList) {
          const dirBtn = card.querySelector('.get-direction-btn');
          if (dirBtn) {
            dirBtn.addEventListener('click', (evt) => {
              evt.stopPropagation();
              getDirectionsForEvent(event);
            });
          }
        }
        card.addEventListener('click', () => {
          showEventDetails(event.id);
        });
        container.appendChild(card);
      });
    }
    
    // Update timers every second
    function updateTimeRemaining() {
      const timeElements = document.querySelectorAll('.time-remaining');
      timeElements.forEach(el => {
        const endTime = new Date(el.getAttribute('data-endtime'));
        const now = new Date();
        const diff = endTime - now;
        if (diff < 0) {
          el.textContent = ' (Expired)';
        } else {
          const minutes = Math.floor(diff / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          el.textContent = ` (Expires in ${minutes}m ${seconds}s)`;
        }
      });
    }
    
    // Get Directions: parse event.location ("POINT(lng lat)") and open Google Maps
    function getDirectionsForEvent(event) {
      if (!event.location) {
        Swal.fire({ icon: 'error', title: 'No Location', text: 'This event has no valid location data.' });
        return;
      }
      const match = event.location.match(/POINT\((-?\d+(\.\d+)?)\s+(-?\d+(\.\d+)?)\)/);
      if (!match) {
        Swal.fire({ icon: 'error', title: 'Invalid Location', text: 'Could not parse event location.' });
        return;
      }
      const lng = match[1], lat = match[3];
      const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
      window.open(googleMapsUrl, '_blank');
    }
    
    // Show Event Details Overlay
    async function showEventDetails(eventId) {
      try {
        const { data: event, error } = await supabaseClient
          .from('events')
          .select('*')
          .eq('id', eventId)
          .single();
        if (error) throw error;
        let content = `<h3>${event.title}</h3>
                       <p>${event.description || 'No details provided.'}</p>
                       <p>Status: ${getEventStatus(event)}</p>`;
        if (event.event_type === 'help' || event.event_type === 'urgent') {
          const { data: participant } = await supabaseClient
            .from('event_participants')
            .select('*')
            .eq('event_id', eventId)
            .eq('user_id', currentUser.user_id)
            .maybeSingle();
          if (!participant && event.user_id !== currentUser.user_id && event.status) {
            content += `<button id="registerBtn">I Can Help</button>`;
          } else if (participant) {
            content += `<p>You are already registered.</p>`;
          }
          if (event.user_id === currentUser.user_id) {
            const { data: participants } = await supabaseClient
              .from('event_participants')
              .select('user_id, attended')
              .eq('event_id', eventId);
            if (participants && participants.length > 0) {
              content += `<h4>Volunteers Registered:</h4><ul>`;
              participants.forEach(p => {
                content += `<li>${p.user_id} ${p.attended ? '<span class="tick">&#10003;</span>' : ''}</li>`;
              });
              content += `</ul>`;
            } else {
              content += `<p>No volunteers registered yet.</p>`;
            }
            content += `<button id="markHelpedBtn">Mark Helped</button>`;
            content += `<button id="endHelpBtn">End Help Request</button>`;
          }
        }
        document.getElementById('eventDetailsContent').innerHTML = content;
        document.getElementById('eventDetailsOverlay').style.display = 'flex';
        
        const registerBtn = document.getElementById('registerBtn');
        if (registerBtn) {
          registerBtn.addEventListener('click', async () => {
            try {
              const { error: regError } = await supabaseClient
                .from('event_participants')
                .insert([{ event_id: eventId, user_id: currentUser.user_id }]);
              if (regError) throw regError;
              Swal.fire({ icon: 'success', title: 'Registered', text: 'You have registered for this event.' });
              closeOverlay('eventDetailsOverlay');
              loadEvents();
            } catch (err) {
              Swal.fire({ icon: 'error', title: 'Registration Error', text: err.message });
            }
          });
        }
        
        const markHelpedBtn = document.getElementById('markHelpedBtn');
        if (markHelpedBtn) {
          markHelpedBtn.addEventListener('click', () => {
            // Fix 2: Check for currentEventIdForMarking existence
            if (!window.currentEventIdForMarking) {
              Swal.fire({ icon: 'error', title: 'Error', text: 'No event selected' });
              return;
            }
            window.currentEventIdForMarking = eventId;
            document.getElementById('qrScannerOverlay').style.display = 'flex';
            startScanner();
          });
        }
        
        const endHelpBtn = document.getElementById('endHelpBtn');
        if (endHelpBtn) {
          endHelpBtn.addEventListener('click', () => {
            Swal.fire({
              title: 'End Event',
              text: 'Are you sure you want to end this event?',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'Yes, end it!',
              cancelButtonText: 'Cancel'
            }).then(async (result) => {
              if (result.isConfirmed) {
                try {
                  const { error: endError } = await supabaseClient
                    .from('events')
                    .update({ status: false })
                    .eq('id', eventId);
                  if (endError) throw endError;
                  Swal.fire({ icon: 'success', title: 'Event Ended', text: 'The event has been ended.' });
                  closeOverlay('eventDetailsOverlay');
                  loadEvents();
                } catch (err) {
                  Swal.fire({ icon: 'error', title: 'Error', text: err.message });
                }
              }
            });
          });
        }
      } catch (err) {
        Swal.fire({ icon: 'error', title: 'Error', text: err.message });
      }
    }
    
    // Close Overlay (Fix 1: reset QR scanner variable)
    function closeOverlay(id) {
      const overlay = document.getElementById(id);
      if (overlay) {
        overlay.style.display = 'none';
        if (id === 'qrOverlay') {
          document.getElementById('qrCodeContainer').innerHTML = '';
        }
        if (id === 'qrScannerOverlay' && html5QrcodeScanner) {
          html5QrcodeScanner.clear().catch(error => { console.error(error); });
          html5QrcodeScanner = null;
        }
      }
    }
    
    // QR Scanner Setup
    let html5QrcodeScanner = null;
    function ensureHtml5QrcodeLibrary(callback) {
      if (window.Html5Qrcode) {
        callback();
      } else {
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js";
        script.onload = () => { callback(); };
        script.onerror = () => {
          Swal.fire({ icon: "error", title: "QR Scanner Error", text: "Failed to load QR scanner library." });
        };
        document.head.appendChild(script);
      }
    }
    
    function startScanner() {
      ensureHtml5QrcodeLibrary(() => {
        let scanTypes = null;
        if (Html5Qrcode.ScanType && Html5Qrcode.ScanType.SCAN_TYPE_CAMERA) {
          scanTypes = [Html5Qrcode.ScanType.SCAN_TYPE_CAMERA];
        } else if (window.Html5QrcodeScanType && window.Html5QrcodeScanType.SCAN_TYPE_CAMERA) {
          scanTypes = [window.Html5QrcodeScanType.SCAN_TYPE_CAMERA];
        }
        const config = { fps: 10, qrbox: 250 };
        if (scanTypes) { config.supportedScanTypes = scanTypes; }
        else { console.warn("No supportedScanTypes defined; using default settings."); }
        if (!html5QrcodeScanner) {
          html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", config);
          html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }
      });
    }
    
    function stopScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.clear().catch(error => { console.error("Scanner cleanup error:", error); });
        html5QrcodeScanner = null;
      }
    }
    
    function onScanSuccess(decodedText, decodedResult) {
      stopScanner();
      processMarkHelp(decodedText);
    }
    
    function onScanFailure(error) {
      console.log("QR scan failure:", error);
    }
    
    document.getElementById('stopScannerBtn').addEventListener('click', () => {
      stopScanner();
      closeOverlay('qrScannerOverlay');
    });
    
    // Process Mark Help (Fix 2: check if currentEventIdForMarking exists)
    async function processMarkHelp(volunteerId) {
      if (!window.currentEventIdForMarking) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'No event selected' });
        return;
      }
      const eventId = window.currentEventIdForMarking;
      const { data: participant } = await supabaseClient
        .from('event_participants')
        .select('*')
        .eq('event_id', eventId)
        .eq('user_id', volunteerId)
        .maybeSingle();
      if (!participant) {
        Swal.fire({ icon: 'error', title: 'Not Registered', text: 'This volunteer is not registered for this event.' });
        return;
      }
      if (participant.attended) {
        Swal.fire({ icon: 'warning', title: 'Already Marked', text: 'This volunteer has already been marked as helped.' });
        return;
      }
      const { error: updateError } = await supabaseClient
        .from('event_participants')
        .update({ attended: true })
        .eq('event_id', eventId)
        .eq('user_id', volunteerId);
      if (updateError) {
        Swal.fire({ icon: 'error', title: 'Error', text: updateError.message });
        return;
      }
      const { data: volunteerData } = await supabaseClient
        .from('users')
        .select('reward_points')
        .eq('user_id', volunteerId)
        .maybeSingle();
      let newPoints = (volunteerData?.reward_points || 0) + 1;
      const { error: updateUserError } = await supabaseClient
        .from('users')
        .update({ reward_points: newPoints })
        .eq('user_id', volunteerId);
      if (updateUserError) {
        Swal.fire({ icon: 'error', title: 'Error', text: updateUserError.message });
        return;
      }
      Swal.fire({ icon: 'success', title: 'Marked Helped', text: `Volunteer ${volunteerId} has been marked as helped and awarded 1 coin.` });
      closeOverlay('qrScannerOverlay');
      loadEvents();
    }
    


    document.getElementById('askHelpBtn').addEventListener('click', () => {
      console.log("Ask Help button clicked.");
      document.getElementById('helpLocation').value = currentUser.location;
      document.getElementById('askHelpOverlay').style.display = 'flex';
    });
    document.getElementById('updateHelpLocationBtn').addEventListener('click', () => {
      if (navigator.geolocation) {
        Swal.fire({ title: 'Fetching Location', text: 'Please wait...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
        navigator.geolocation.getCurrentPosition(position => {
          const lng = position.coords.longitude;
          const lat = position.coords.latitude;
          const point = `POINT(${lng} ${lat})`;
          document.getElementById('helpLocation').value = point;
          Swal.close();
          console.log("Help location updated:", point);
        }, error => {
          Swal.close();
          Swal.fire({ icon: 'error', title: 'Location Error', text: 'Unable to fetch location. Please try again.' });
        });
      } else {
        Swal.fire({ icon: 'error', title: 'Not Supported', text: 'Geolocation is not supported by your browser.' });
      }
    });
    document.getElementById('askHelpForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const helpDetails = document.getElementById('helpDetails').value.trim();
      const volunteersNeeded = parseInt(document.getElementById('volunteersNeeded').value);
      const helpLocation = document.getElementById('helpLocation').value;
      const expireSeconds = parseInt(document.getElementById('helpExpireTime').value);
      if (!helpDetails || !volunteersNeeded || !helpLocation) {
        Swal.fire({ icon: 'warning', title: 'Missing Fields', text: 'Please complete all fields.' });
        return;
      }
      const now = new Date();
      const expireTime = new Date(now.getTime() + expireSeconds * 1000);
      document.getElementById('askHelpForm').querySelector('button[type="submit"]').disabled = true;
      try {
        const { data, error } = await supabaseClient
          .from('events')
          .insert([{
            user_id: currentUser.user_id,
            title: 'Help Request',
            description: helpDetails,
            event_type: 'help',
            location: helpLocation,
            status: true,
            start_time: now.toISOString(),
            end_time: expireTime.toISOString(),
            max_participants: volunteersNeeded
          }]);
        if (error) throw error;
        console.log("Help request created:", data);
        Swal.fire({ icon: 'success', title: 'Help Request Created', text: 'Your help request has been posted.' });
        closeOverlay('askHelpOverlay');
        loadEvents();
      } catch (err) {
        Swal.fire({ icon: 'error', title: 'Error', text: err.message });
      } finally {
        document.getElementById('askHelpForm').querySelector('button[type="submit"]').disabled = false;
      }
    });
    
    // 13. Urgent Emergency overlay with speech recognition
    let recognition;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('emergencyVoiceMsg').value = transcript;
        console.log("Voice transcript:", transcript);
      };
      recognition.onerror = function(event) {
        Swal.fire({ icon: 'error', title: 'Speech Recognition Error', text: event.error });
      };
    } else {
      document.getElementById('recordVoiceBtn').disabled = true;
      document.getElementById('emergencyVoiceMsg').placeholder = 'Voice input not supported - type your message';
    }
    document.getElementById('urgentEmergencyBtn').addEventListener('click', () => {
      console.log("Urgent Emergency button clicked.");
      document.getElementById('urgentEmergencyOverlay').style.display = 'flex';
    });
    document.getElementById('recordVoiceBtn').addEventListener('click', () => {
      if (recognition) {
        console.log("Starting voice recognition...");
        recognition.start();
        Swal.fire({ icon: 'info', title: 'Recording...', text: 'Speak now. Click OK when finished.', allowOutsideClick: false });
      }
    });
    document.getElementById('submitEmergencyBtn').addEventListener('click', async () => {
      const voiceMsg = document.getElementById('emergencyVoiceMsg').value.trim();
      if (!voiceMsg) {
        Swal.fire({ icon: 'warning', title: 'No Message', text: 'Please record a voice message.' });
        return;
      }
      const transcribed = "Transcribed: " + voiceMsg;
      const now = new Date();
      const expireTime = new Date(now.getTime() + 86400 * 1000);
      try {
        const { data, error } = await supabaseClient
          .from('events')
          .insert([{
            user_id: currentUser.user_id,
            title: 'Urgent Emergency',
            description: transcribed,
            event_type: 'urgent',
            location: currentUser.location,
            status: true,
            start_time: now.toISOString(),
            end_time: expireTime.toISOString(),
            max_participants: 10
          }]);
        if (error) throw error;
        console.log("Urgent emergency event created:", data);
        Swal.fire({ icon: 'success', title: 'Emergency Sent', text: 'Your emergency help request has been posted.' });
        closeOverlay('urgentEmergencyOverlay');
        loadEvents();
      } catch (err) {
        Swal.fire({ icon: 'error', title: 'Error', text: err.message });
      }
    });
    
    // 14. Under Development buttons
    document.getElementById('hostEventBtn').addEventListener('click', () => {
      Swal.fire({ title: 'Host Event', text: 'This feature will allow you to host events. (Under Development)', icon: 'info' });
    });
    document.getElementById('exchangeBtn').addEventListener('click', () => {
      Swal.fire({ title: 'Exchange/Borrow', text: 'This feature will allow you to exchange or borrow items. (Under Development)', icon: 'info' });
    });
    document.getElementById('onlineGamesBtn').addEventListener('click', () => {
      Swal.fire({ title: 'Online Games', text: 'This feature will be added soon!', icon: 'info' });
    });
    
    // 15. Reload events when radius changes
    document.getElementById('radiusSelector').addEventListener('change', () => {
      console.log("Radius changed, reloading events...");
      loadEvents();
    });







    // Profile Edit: Show Edit Profile Overlay
    document.getElementById('editProfileBtn').addEventListener('click', () => {
      document.getElementById('editProfileOverlay').style.display = 'flex';
      document.getElementById('editName').value = currentUser.name;
      document.getElementById('editPhone').value = currentUser.phone;
      document.getElementById('editEmail').value = currentUser.email;
      document.getElementById('editLocation').value = currentUser.location;
    });
    
    // Edit Profile: Get Location for profile editing
    document.getElementById('editGetLocationBtn').addEventListener('click', () => {
      if (navigator.geolocation) {
        Swal.fire({ title: 'Fetching Location', text: 'Please wait...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
        navigator.geolocation.getCurrentPosition(position => {
          const lng = position.coords.longitude;
          const lat = position.coords.latitude;
          const point = `POINT(${lng} ${lat})`;
          document.getElementById('editLocation').value = point;
          document.getElementById('editLocationDisplay').textContent = 'Location: ' + point;
          Swal.close();
        }, error => {
          Swal.close();
          Swal.fire({ icon: 'error', title: 'Location Error', text: 'Unable to fetch location. Please try again.' });
        });
      } else {
        Swal.fire({ icon: 'error', title: 'Not Supported', text: 'Geolocation is not supported by your browser.' });
      }
    });
    
    // Edit Profile: Submit changes; if new password is provided, validate length (Fix 4)
    document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newName = document.getElementById('editName').value.trim();
      const newPhone = document.getElementById('editPhone').value.trim();
      const newEmail = document.getElementById('editEmail').value.trim();
      const newPassword = document.getElementById('editPassword').value;
      const newLocation = document.getElementById('editLocation').value;
      
      if (newPassword && newPassword.length < 6) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Password must be at least 6 characters' });
        return;
      }
      
      try {
        const updateData = { name: newName, phone: newPhone, email: newEmail, location: newLocation };
        if (newPassword) { updateData.password = newPassword; }
        const { error } = await supabaseClient
          .from('users')
          .update(updateData)
          .eq('user_id', currentUser.user_id);
        if (error) throw error;
        Swal.fire({ icon: 'success', title: 'Profile Updated', text: 'Your profile has been updated. Please log in again.' })
          .then(() => {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
          });
      } catch (err) {
        Swal.fire({ icon: 'error', title: 'Error', text: err.message });
      }
    });
    
    // Logout (Profile Section & Bottom Nav already wired)
    document.getElementById('logoutBtn').addEventListener('click', () => {
      Swal.fire({ icon: 'success', title: 'Logged Out', text: 'You have been successfully logged out.' })
      .then(() => {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      });
    });
    
    // "My QR" in Profile Section already wired above in bottom nav
    
    // Periodically load events via realtime subscriptions (no polling needed)
    loadEvents();
    
    // Global error handler
    window.addEventListener('error', (event) => {
      Swal.fire({
        icon: 'error',
        title: 'Application Error',
        text: event.error ? event.error.message : 'An error occurred.',
        footer: `${event.filename}:${event.lineno}`
      });
    });
    
    // Cleanup on unload (Fix 5: clear vibration intervals and unsubscribe)
    window.addEventListener('beforeunload', () => {
      Object.values(urgentVibrationIntervals).forEach(clearInterval);
      urgentVibrationIntervals = {};
      supabaseClient.removeSubscription(eventsSubscription);
      supabaseClient.removeSubscription(coinSubscription);
    });
  </script>
</body>
</html>
